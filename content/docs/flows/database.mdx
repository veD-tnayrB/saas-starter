---
title: Database Flow
description: Data persistence and management with PostgreSQL using Kysely and raw SQL
Last updated at: 2025-10-21
---

## Overview

Manages data persistence using PostgreSQL with Kysely and raw SQL. Handles user authentication, session management, and subscription data with proper relationships and constraints.

**Main libraries/services:**

- `kysely` - Type-safe SQL query builder
- Custom raw SQL repositories - Fine-grained control over complex queries
- PostgreSQL - Primary database (Neon hosting)
- SQL migrations (`/migrations`) for schema management

## File Map

```
ğŸ“ migrations/             - SQL migration files
ğŸ“ lib/db.ts               - Kysely client configuration
ğŸ“ lib/db.types.ts         - Database type definitions for Kysely
ğŸ“ repositories/           - Data access layer (Kysely + raw SQL)
ğŸ“ services/               - Business logic built on repositories
ğŸ“ actions/                - Server actions orchestrating database operations
```

## Database Schema

Schema changes are managed through SQL migrations under `/migrations`. Key tables:

- **users** â€“ Stores profile data, OAuth linkage, and Stripe identifiers
- **accounts** â€“ OAuth provider accounts linked to users
- **sessions** â€“ NextAuth session tokens with expiry metadata
- **projects / project_members / project_invitations** â€“ Core project collaboration tables
- **subscription_plans / subscriptions** â€“ Billing and plan data

Refer to the latest migration files for the exact SQL definitions.

## Step-by-Step Flow

### User Creation (OAuth)

1. User authenticates via OAuth provider
2. NextAuth KyselyAdapter handles user creation through raw SQL repositories
3. User record created with OAuth account linked
4. Stripe customer ID generated (if needed)
5. User role set to default "USER"

### User Lookup Operations

1. `getUserById(id)` - Fetches user by ID
2. `getUserByEmail(email)` - Fetches user by email
3. `getCurrentUser()` - Gets current session user
4. All operations include proper error handling

### Subscription Data Management

1. `getUserSubscriptionPlan(userId)` - Fetches subscription data
2. Stripe webhooks update subscription fields
3. Plan validation against current period end
4. Pricing data matching against Stripe price IDs

### Database Connection Management

1. Kysely client configured with connection pooling
2. Development: Cached global instance
3. Production: New instance per request
4. Automatic connection management

## Data Flow Diagram

```
[NextAuth] â†’ [KyselyAdapter] â†’ [User Creation/Update] â†’ [Database]
     â†“
[Webhooks] â†’ [Subscription Updates] â†’ [Database]
     â†“
[Queries] â†’ [Kysely Client + raw SQL] â†’ [Database] â†’ [Application Logic]
```

## Database Operations

### User CRUD

- **Create**: Via NextAuth OAuth flow
- **Read**: `getUserById`, `getUserByEmail`, `getCurrentUser`
- **Update**: Via webhooks and user actions
- **Delete**: Cascade delete with accounts/sessions

### Subscription CRUD

- **Create**: Via Stripe webhooks
- **Read**: `getUserSubscriptionPlan`
- **Update**: Via Stripe webhooks (renewals, changes)
- **Delete**: Via Stripe cancellation webhooks

## Environment Configuration

- **DATABASE_URL**: PostgreSQL connection string
- **Neon**: Hosted PostgreSQL service
- **Migrations**: Managed via SQL files executed with preferred migration runner

## Notes and TODOs

- âœ… User authentication with OAuth integration
- âœ… Session management with JWT strategy
- âœ… Stripe subscription data persistence
- âœ… Proper foreign key relationships
- âœ… Cascade delete for data integrity
- âš ï¸ No soft delete implementation
- ğŸ”„ Add user profile management
- ğŸ”„ Implement audit logging
- ğŸ”„ Add database backup strategies
- ğŸ”„ Consider adding user preferences table
- ğŸ”„ Add indexes for performance optimization
