---
title: Stripe Integration Flow
description: Subscription management and payment processing with Stripe
Last updated at: 2025-10-21
---

## Overview

Handles subscription management, payment processing, and billing operations using Stripe. Supports multiple subscription tiers with monthly/yearly billing cycles and webhook-based subscription lifecycle management.

**Main libraries/services:**

- `stripe` - Payment processing and subscription management
- `@stripe/stripe-js` - Client-side Stripe integration
- Webhook endpoints for real-time subscription updates
- Prisma for subscription data persistence

## File Map

```
ğŸ“ lib/stripe.ts - Stripe client configuration
ğŸ“ config/subscriptions.ts - Pricing plans and tier definitions
ğŸ“ lib/subscription.ts - Subscription logic and plan detection
ğŸ“ actions/generate-user-stripe.ts - Checkout session creation
ğŸ“ actions/open-customer-portal.ts - Billing portal access
ğŸ“ app/api/webhooks/stripe/route.ts - Webhook event handling
ğŸ“ components/forms/billing-form-button.tsx - Billing UI components
ğŸ“ components/pricing/ - Pricing page components
ğŸ“ app/(protected)/dashboard/billing/page.tsx - Billing dashboard
ğŸ“ app/(marketing)/pricing/page.tsx - Public pricing page
```

## Step-by-Step Flow

### New Subscription Creation

1. User clicks "Upgrade" button on pricing page
2. `generateUserStripe` action is triggered with priceId
3. User authentication is verified via `auth()`
4. Current subscription status is checked via `getUserSubscriptionPlan`
5. If user is on free plan:
   - Stripe checkout session is created with user email
   - User metadata (userId) is attached to session
   - User is redirected to Stripe checkout
6. User completes payment on Stripe
7. Stripe webhook `checkout.session.completed` is triggered
8. User subscription data is updated in database

### Subscription Management (Existing Customers)

1. User clicks "Manage Billing" button
2. `generateUserStripe` checks if user has active subscription
3. If user is on paid plan:
   - Stripe billing portal session is created
   - User is redirected to Stripe customer portal
4. User can update payment methods, cancel, or change plans
5. Changes trigger webhook events for real-time updates

### Webhook Event Processing

1. Stripe sends webhook to `/api/webhooks/stripe`
2. Webhook signature is verified using `STRIPE_WEBHOOK_SECRET`
3. Event type determines processing logic:
   - `checkout.session.completed`: New subscription created
   - `invoice.payment_succeeded`: Subscription renewed/updated
4. Database is updated with latest subscription data
5. Response sent back to Stripe

### Subscription Plan Detection

1. `getUserSubscriptionPlan` fetches user's Stripe data
2. Plan validity is checked against current period end
3. Pricing data is matched against user's `stripePriceId`
4. Plan details (tier, interval, cancellation status) are returned
5. UI components use this data for conditional rendering

## Data Flow Diagram

```
[Pricing Page] â†’ [Checkout Session] â†’ [Stripe Payment] â†’ [Webhook] â†’ [Database Update]
     â†“
[User Dashboard] â† [Subscription Status] â† [Plan Detection] â† [Database Query]
     â†“
[Billing Portal] â†’ [Stripe Portal] â†’ [Plan Changes] â†’ [Webhook] â†’ [Database Update]
```

## Subscription Tiers

- **Starter**: Free tier (no Stripe integration)
- **Pro**: $15/month or $144/year
- **Business**: $30/month or $300/year

## Notes and TODOs

- âœ… Checkout session creation for new subscriptions
- âœ… Billing portal integration for existing customers
- âœ… Webhook handling for subscription lifecycle events
- âœ… Multi-tier pricing with monthly/yearly options
- âœ… Subscription status detection and plan matching
- âš ï¸ Webhook error handling could be improved
- ğŸ”„ Add support for proration when changing plans
- ğŸ”„ Implement subscription cancellation grace periods
- ğŸ”„ Add usage-based billing for higher tiers
- ğŸ”„ Consider adding trial periods for new users
