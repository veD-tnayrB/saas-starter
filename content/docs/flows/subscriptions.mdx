---
title: Subscriptions Flow
description: End-to-end explanation of the subscription lifecycle and Stripe integration
lastUpdated: 2025-11-08
---

## Overview

The subscriptions flow handles plan selection, checkout, upgrades/downgrades, cancellation, and webhook synchronization with Stripe. `services/subscriptions` orchestrates Stripe API calls and repository updates, ensuring the database reflects the current billing state. Helper utilities normalize plan data, while webhook handlers keep plans and renewal dates accurate after Stripe events.

**Main Libraries/Services:**

- **services/subscriptions/get-plan.ts** – Retrieves the active subscription plan (per project or user) and formats it for UI.
- **services/subscriptions/create.ts** – Validates and creates Stripe checkout sessions for new subscriptions.
- **services/subscriptions/update.ts** – Upgrades/downgrades existing subscriptions by updating Stripe price IDs.
- **services/subscriptions/cancel.ts** – Cancels subscriptions and updates local state.
- **services/subscriptions/webhooks.ts** – Processes Stripe webhook events (checkout completion, invoice payments) and sends confirmation emails.
- **services/subscriptions/helpers.ts** – Utility functions for plan lookup, interval detection, formatting, and validation.
- **repositories/subscriptions** – Persists subscription records (customer IDs, price IDs, current period end) and provides lookup helpers.
- **clients/stripe** – Wrapper around the Stripe SDK for checkout session creation, subscription retrieval, and updates.

## File Map

- `services/subscriptions/index.ts` – Exports public surface: `createSubscription`, `updateSubscription`, `cancelSubscription`, `getProjectSubscriptionPlan`, `getUserSubscriptionPlan`, webhook handlers.
- `services/subscriptions/get-plan.ts` – Implements plan retrieval logic with project fallback, default plan handling, and Stripe subscription lookups.
- `services/subscriptions/create.ts` – Validates eligibility, builds checkout sessions, and returns hosted payment URLs.
- `services/subscriptions/update.ts` – Validates upgrades/downgrades, updates Stripe subscriptions, and persists new price IDs.
- `services/subscriptions/cancel.ts` – Cancels subscriptions in Stripe and marks them canceled locally.
- `services/subscriptions/webhooks.ts` – Handles `checkout.session.completed` and `invoice.payment_succeeded` events; sends confirmation emails via Resend.
- `services/subscriptions/helpers.ts` – Shared helpers (plan lookup, interval determination, default plan fallback, price ID validation).
- `repositories/subscriptions/index.ts` – Database access: find/update user subscriptions, update price IDs, update billing periods.
- `emails/subscription-confirmation-email.tsx` – React Email template for subscription confirmation.
- `actions/generate-user-stripe.ts` / `actions/open-customer-portal.ts` – Server actions that call billing + subscription services to create checkout/portal URLs.

## Step-by-Step Flow

### Plan Retrieval (`getProjectSubscriptionPlan`)

1. Consumers (dashboard, billing UI) call `getProjectSubscriptionPlan(projectId)`.
2. Service loads the project record; if a subscription plan is assigned, it derives plan metadata from pricing config and owner’s Stripe subscription.
3. If the project has no plan, it falls back to the owner’s personal subscription or the default plan (Starter).
4. Helper utilities (`isSubscriptionActive`, `determinePlanInterval`, `formatSubscriptionPlan`) calculate paid status, interval, cancellation state, and return a consistent `IUserSubscriptionPlan`.

### New Subscription Checkout (`createSubscription`)

1. UI invokes `createSubscription(userId, priceId, email)` via server action.
2. Service validates inputs, price format, plan existence, and eligibility (user does not already have an active subscription).
3. A Stripe Checkout session is created through `createCheckoutSession`; metadata includes `userId`.
4. Hosted checkout URL is returned for client redirection.

### Subscription Upgrade/Downgrade (`updateSubscription`)

1. UI triggers an upgrade/downgrade with subscription ID and target price ID.
2. Service validates plan transition (`validateSubscriptionUpdate`) and ensures the new price ID is different and valid.
3. Stripe subscription is updated (`updateStripeSubscription`) with proration enabled.
4. Local repository updates user price ID to keep the database in sync.

### Cancellation (`cancelSubscription`)

1. User requests cancellation by supplying the Stripe subscription ID.
2. Service validates the subscription exists and is active; Stripe subscription is canceled (at period end unless immediate cancellation is configured).
3. Repository marks the subscription as canceled locally via `cancelUserSubscription`.

### Webhook Handling (`handleWebhookEvent`)

1. Stripe sends events to the webhook endpoint, which calls `handleWebhookEvent`.
2. `checkout.session.completed`:
   - Subscription details are retrieved.

- `updateUserOnSubscriptionCreate` persists subscription/customer IDs, price ID, and period end.
- A confirmation email is rendered (`SubscriptionConfirmationEmail`) and sent via Resend on a best-effort basis.

3. `invoice.payment_succeeded`:
   - Detects upgrades/downgrades (billing reason other than subscription_create).
   - Retrieves updated subscription info and syncs price ID and period end via repositories.
4. Unknown events are logged without error.

## Data Flow Diagram

```mermaid
flowchart TD
  A[Dashboard/User Action] --> B[Server Action (generate/open portal)]
  B --> C[BillingService or SubscriptionService]
  C --> D[Stripe Checkout/Billing Portal]
  D --> E[Stripe Webhooks]
  E --> F[handleWebhookEvent]
  F --> G[repositories/subscriptions]
  G --> H[(PostgreSQL)]
  F --> I[Resend Confirmation Email]
  H --> J[UI reload via getProjectSubscriptionPlan]
```

## Dependencies & Contracts

- `createSubscription(userId, priceId, email)` → `{ success, data?: { url }, error? }`
- `updateSubscription(subscriptionId, priceId)` → `{ success, data?: { subscriptionId, status }, error? }`
- `cancelSubscription(subscriptionId)` → `{ success, data?: { subscriptionId, status, canceledAt }, error? }`
- `getProjectSubscriptionPlan(projectId)` / `getUserSubscriptionPlan(userId)` → `IUserSubscriptionPlan`
- `handleWebhookEvent(event)` → `{ success, data?, error? }`; orchestrates `handleCheckoutCompleted` & `handlePaymentSucceeded`
- `helpers.ts` – `findPlanByPriceId`, `determinePlanInterval`, `formatSubscriptionPlan`, `validatePriceId`, `calculateGracePeriod`, `getDefaultPlan`
- Repositories (`findUserSubscription`, `updateUserOnSubscriptionCreate`, `updateSubscriptionPrice`, `updateSubscriptionPeriod`, `cancelUserSubscription`) synchronize local state.
- `pricingData` (config file) – Defines available plans, price IDs, and feature sets.

## Known Limitations

- `getUserSubscriptionPlan` is maintained for backward compatibility; the system should primarily rely on project-scoped plan retrieval.
- Subscription creation and updates assume synchronous Stripe responses; failures rely on console logging without retries.
- Cancellation always sets Stripe to cancel at period end; immediate cancellation flows are not exposed.
- Confirmation email failures are logged but not retried or surfaced to the user.
- Grace period logic is hard-coded (one day) and not configurable per plan.

## Notes & TODOs

- Replace `getUserSubscriptionPlan` with project-scoped checks everywhere and phase out the backward compatibility path.
- Add retry/queue mechanisms for webhook-driven emails and Stripe API calls.
- Expose immediate cancellation or refund flows as optional behavior.
- Extend webhook handling to cover additional events (payment failures, subscription trials ending, customer deletions).
- Add audit logging and metrics for subscription changes to aid support and debugging.
