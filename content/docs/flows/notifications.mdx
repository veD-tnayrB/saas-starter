---
title: Notifications Flow
description: End-to-end explanation of the notifications flow
lastUpdated: 2025-11-08
---

## Overview

The notifications flow delivers transactional emails for onboarding, verification, password resets, and account changes. `services/notifications` orchestrates these flows by marshalling user data, selecting the correct template, and delegating delivery to the email client (`clients/auth/email`). Preferences are currently hard-coded but designed to evolve into persisted user settings.

**Main Libraries/Services:**

- **services/notifications** – High-level notification orchestrator with methods like `sendWelcomeEmail`, `sendPasswordResetEmail`, and `sendCustomEmail`.
- **clients/auth/email** – Low-level email client that actually renders and sends messages through the configured provider (Resend).
- **services/auth/user** / **repositories/auth** – Provide user data to ensure the recipient exists and has an email.
- **services/auth/verification** and **services/auth/session** – Supply verification/reset tokens that are embedded in messages.
- **React Email templates (`emails/*.tsx`)** – Render transactional email content (welcome, password reset, invitation, etc.).

## File Map

- `services/notifications/index.ts` – NotificationService implementation; routes requests to specific email methods, validates input, and returns `NotificationResult`.
- `clients/auth/email.ts` – Wrapper around the email provider (Resend) with helper methods (`sendWelcomeEmail`, `sendPasswordResetEmail`, etc.).
- `emails/*` – React Email templates invoked by the email client to format HTML emails.
- `services/auth/verification.ts` – Generates/consumes verification tokens used in verification and password reset flows.
- `services/auth/registration.ts` – Calls NotificationService to send welcome or invitation emails when new users register.
- `actions/*` – Server actions that invoke NotificationService for UI-driven flows like password reset requests.

## Step-by-Step Flow

### Welcome Email

1. A new account is created through registration or OAuth onboarding (`services/auth/registration` or NextAuth `createUser` event).
2. Registration service prepares the `IAuthUser` payload and calls `notificationService.sendWelcomeEmail`.
3. NotificationService validates that the user has an email address and delegates to `emailClient.sendWelcomeEmail`.
4. The email client renders the React Email template and sends it via Resend, returning a message ID.
5. NotificationService wraps the outcome in a `NotificationResult` (success or error) for logging or UI feedback.

### Password Reset Email

1. A user requests a password reset (via server action or API endpoint).
2. Verification service generates a reset token and calls `notificationService.sendPasswordResetEmail`.
3. NotificationService ensures the user has an email, then invokes `emailClient.sendPasswordResetEmail(user, token)`.
4. The email contains a reset link (URL composed by the caller or defaults inside the email client).
5. The flow returns a `NotificationResult`; errors are logged for troubleshooting.

### Email Verification

1. When a user needs to verify their email, verification service creates a verification token.
2. `sendVerificationEmail` uses the token and user data to trigger `emailClient.sendVerificationEmail`.
3. The message includes a verification link, after which the user’s email is marked as verified.

### Account Deletion

1. When a user deletes their account (or an admin removes them), the application invokes `sendAccountDeletionEmail`.
2. NotificationService calls `emailClient.sendAccountDeletionEmail(user)` to notify the user of the account removal and any next steps.

### Custom Email Routing

1. `sendCustomEmail` accepts a template name and template data.
2. The method routes to specific helpers (`sendWelcomeEmail`, `sendPasswordResetEmail`, `sendVerificationEmail`, `sendAccountDeletionEmail`) based on the template string.
3. If no known template is provided, the method throws an error to avoid sending incomplete or unapproved emails.

## Data Flow Diagram

```mermaid
flowchart TD
  A[Trigger (registration / password reset / admin action)] --> B[NotificationService]
  B --> C[emailClient (Resend)]
  C --> D[React Email templates]
  D --> E[Email Provider (Resend API)]
  E --> F[Recipient inbox]
```

## Dependencies & Contracts

- `NotificationResult` – Standard response indicating success, optional `messageId`, and optional `error`.
- `WelcomeEmailData`, `PasswordResetEmailData`, `VerificationEmailData`, `AccountDeletionEmailData` – Input contracts required by NotificationService.
- `EmailNotificationData` – Generic contract used by `sendCustomEmail` routing logic.
- Tokens (`resetToken`, `verificationToken`) – Generated by verification services and used to build secure links.
- `emailClient` methods – Each expects an `IAuthUser` with a valid email and optional metadata to render templates.

## Known Limitations

- Notification preferences are not persisted; `getUserNotificationPreferences` always returns defaults and `updateUserNotificationPreferences` only logs changes.
- There is no retry or queueing mechanism; delivery failures rely on exceptions from Resend.
- `sendCustomEmail` only supports a predefined set of template names; new templates require code changes.
- Templates and subjects are not localized; internationalization would require additional metadata and template variants.

## Notes & TODOs

- Persist notification preferences per user and integrate them into the send\* email methods for opt-out handling.
- Add retry/queue support (e.g., using background jobs) to improve resilience against transient email provider outages.
- Expand `sendCustomEmail` to support dynamic templates with validation of required parameters.
- Introduce localization for email subjects and bodies, possibly leveraging translation files or template engines.
